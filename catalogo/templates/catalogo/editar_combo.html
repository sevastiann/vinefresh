{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="form-container">
    <h2>Editar Combo</h2>

    <form method="POST" action="" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Nombre -->
        <div class="form-group">
            <label for="nombre">Nombre del Combo:</label>
            <input type="text" id="nombre" name="nombre" value="{{ combo.nombre }}" required>
        </div>

        <!-- Precio -->
        <div class="form-group">
            <label for="precio">Precio:</label>
            <input type="number" step="0.01" id="precio" name="precio" value="{{ combo.precio }}" required>
        </div>

        <!-- Unidades -->
        <div class="form-group">
            <label for="unidades">Unidades:</label>
            <input type="number" id="unidades" name="unidades" value="{{ combo.unidades }}" required>
        </div>

        <!-- Descripción -->
        <div class="form-group">
            <label for="descripcion">Descripción:</label>
            <textarea id="descripcion" name="descripcion" rows="3">{{ combo.descripcion }}</textarea>
        </div>

        <!-- Imagen -->
        <div class="form-group">
            <label for="imagen">Foto del Combo (opcional):</label>
            <input type="file" id="imagen" name="imagen" accept="image/*">
            {% if combo.imagen %}
                <p>Imagen actual: <img src="{{ combo.imagen.url }}" alt="Combo" width="100"></p>
            {% endif %}
        </div>

        <!-- Categorías principales -->
        <div class="form-group">
            <label>Categorías principales:</label>
            {% for categoria in categorias_combos %}
                <div>
                    <input type="checkbox" class="categoria-principal" name="categorias" value="{{ categoria.id }}"
                    {% if categoria.id in combo.categorias.all.values_list('id', flat=True) %} checked {% endif %}>
                    <label>{{ categoria.nombre }}</label>
                </div>
            {% endfor %}
        </div>

        <!-- Subcategorías -->
        <div class="form-group">
            <label>Subcategorías:</label>
            <div id="subcategorias-container">
                {% for sub in combo.subcategorias.all %}
                    <div>
                        <input type="checkbox" name="subcategorias" value="{{ sub.id }}" checked>
                        <label>{{ sub.nombre }}</label>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Botones -->
        <div class="form-group botones">
            <button type="submit" class="btn">Guardar cambios</button>
            <a href="{% url 'catalogo:admin_lista_catalogo' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

<script>
    // Manejar subcategorías dinámicamente
    const subcategoriasData = {{ categorias_json|safe }};
    const catCheckboxes = document.querySelectorAll('.categoria-principal');
    const subContainer = document.getElementById('subcategorias-container');

    function actualizarSubcategorias() {
        subContainer.innerHTML = '';
        catCheckboxes.forEach(c => {
            if(c.checked && subcategoriasData[c.value]) {
                subcategoriasData[c.value].forEach(sub => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <input type="checkbox" name="subcategorias" value="${sub.id}">
                        <label>${sub.nombre}</label>
                    `;
                    subContainer.appendChild(div);
                });
            }
        });
    }

    catCheckboxes.forEach(cb => cb.addEventListener('change', actualizarSubcategorias));
</script>

{% endblock %}

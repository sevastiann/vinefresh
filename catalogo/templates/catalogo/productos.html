{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/catalogo/productos.css' %}">

<div class="layout-container">

    <!-- ===========================
         üî∏ SIDEBAR
    ============================ -->
    <aside class="sidebar">

        <!-- üîç Buscador -->
        <div class="buscador mb-4">
            <input type="text" id="buscar" placeholder="Buscar por nombre..." class="input-buscar">
            <button class="btn-buscar">üîç</button>
        </div>

        <!-- üí∞ Filtro de precio -->
        <div class="filtro-precio mb-5">
            <label class="bloque-texto font-semibold mb-2">Filtrar por precio</label>
            <div class="precio-inputs">
                <input type="number" id="precio_min" placeholder="M√≠nimo" class="input-precio">
                <span>‚Äî</span>
                <input type="number" id="precio_max" placeholder="M√°ximo" class="input-precio">
            </div>
        </div>

        <!-- üçá Filtros seg√∫n secci√≥n -->
        <div class="filtros-plegables">
            {% if seccion == "vinos" %}
            <details open>
                <summary>Pa√≠s</summary>
                <ul class="lista-filtro">
                    <li><input type="checkbox" name="pais" value="Chile" id="pais1"><label for="pais1">Chile</label></li>
                    <li><input type="checkbox" name="pais" value="Argentina" id="pais2"><label for="pais2">Argentina</label></li>
                    <li><input type="checkbox" name="pais" value="Espa√±a" id="pais3"><label for="pais3">Espa√±a</label></li>
                    <li><input type="checkbox" name="pais" value="Italia" id="pais4"><label for="pais4">Italia</label></li>
                    <li><input type="checkbox" name="pais" value="Francia" id="pais5"><label for="pais5">Francia</label></li>
                    <li><input type="checkbox" name="pais" value="Colombia" id="pais6"><label for="pais6">Colombia</label></li>
                    <li><input type="checkbox" name="pais" value="M√©xico" id="pais7"><label for="pais7">M√©xico</label></li>
                </ul>
            </details>

            <details>
                <summary>Color</summary>
                <ul class="lista-filtro">
                    <li><input type="checkbox" name="color" value="Tinto" id="color1"><label for="color1">Tinto</label></li>
                    <li><input type="checkbox" name="color" value="Blanco" id="color2"><label for="color2">Blanco</label></li>
                    <li><input type="checkbox" name="color" value="Rosado" id="color3"><label for="color3">Rosado</label></li>
                </ul>
            </details>

            <details>
                <summary>Grado de Alcohol</summary>
                <ul class="lista-filtro">
                    <li><input type="checkbox" name="alcohol" value="Menos de 10%" id="alcohol1"><label
                            for="alcohol1">Menos de 10%</label></li>
                    <li><input type="checkbox" name="alcohol" value="10% - 13%" id="alcohol2"><label
                            for="alcohol2">10% - 13%</label></li>
                    <li><input type="checkbox" name="alcohol" value="M√°s de 13%" id="alcohol3"><label for="alcohol3">M√°s de
                            13%</label></li>
                </ul>
            </details>

            <details>
                <summary>Tipo de Uva</summary>
                <ul class="lista-filtro">
                    <li><input type="checkbox" name="uva" value="Cabernet Sauvignon" id="uva1"><label
                            for="uva1">Cabernet Sauvignon</label></li>
                    <li><input type="checkbox" name="uva" value="Malbec" id="uva2"><label for="uva2">Malbec</label></li>
                    <li><input type="checkbox" name="uva" value="Merlot" id="uva3"><label for="uva3">Merlot</label></li>
                    <li><input type="checkbox" name="uva" value="Sauvignon Blanc" id="uva4"><label
                            for="uva4">Sauvignon Blanc</label></li>
                    <li><input type="checkbox" name="uva" value="Verdejo" id="uva5"><label for="uva5">Verdejo</label></li>
                    <li><input type="checkbox" name="uva" value="Carm√©n√®re" id="uva6"><label for="uva6">Carm√©n√®re</label>
                    </li>
                    <li><input type="checkbox" name="uva" value="Nebbiolo" id="uva7"><label for="uva7">Nebbiolo</label></li>
                    <li><input type="checkbox" name="uva" value="Pinot Noir" id="uva8"><label for="uva8">Pinot Noir</label>
                    </li>
                    <li><input type="checkbox" name="uva" value="Grenache" id="uva9"><label for="uva9">Grenache</label></li>
                </ul>
            </details>

            <details>
                <summary>Volumen</summary>
                <ul class="lista-filtro">
                    <li><input type="checkbox" name="vol" value="375 ml" id="vol1"><label for="vol1">375 ml</label></li>
                    <li><input type="checkbox" name="vol" value="750 ml" id="vol2"><label for="vol2">750 ml</label></li>
                    <li><input type="checkbox" name="vol" value="1 L" id="vol3"><label for="vol3">1 L</label></li>
                </ul>
            </details>

            {% elif seccion == "combos" %}

            <details open>
                <summary>Festividad</summary>
                <ul class="lista-filtro">
                    <li><input type="checkbox" name="fest" value="Navidad" id="fest1"><label for="fest1">Navidad</label></li>
                    <li><input type="checkbox" name="fest" value="A√±o Nuevo" id="fest2"><label for="fest2">A√±o Nuevo</label>
                    </li>
                    <li><input type="checkbox" name="fest" value="San Valent√≠n" id="fest3"><label for="fest3">San Valent√≠n</label></li>
                    <li><input type="checkbox" name="fest" value="D√≠a del Padre" id="fest4"><label for="fest4">D√≠a del Padre</label></li>
                    <li><input type="checkbox" name="fest" value="D√≠a de la Madre" id="fest5"><label for="fest5">D√≠a de la Madre</label></li>
                </ul>
            </details>

            <details>
                <summary>Premium</summary>
                <ul class="lista-filtro">
                    <li><input type="checkbox" name="prem" value="premium_gold" id="prem1"><label for="prem1">Gold</label>
                    </li>
                    <li><input type="checkbox" name="prem" value="premium_platinum" id="prem2"><label
                            for="prem2">Platinum</label></li>
                    <li><input type="checkbox" name="prem" value="premium_black_label" id="prem3"><label
                            for="prem3">Black Label</label></li>
                </ul>
            </details>

            <details>
                <summary>Regalo</summary>
                <ul class="lista-filtro">
                    <li><input type="checkbox" name="reg" value="regalo_amistad" id="reg1"><label
                            for="reg1">Amistad</label></li>
                    <li><input type="checkbox" name="reg" value="regalo_cumplea√±os" id="reg2"><label
                            for="reg2">Cumplea√±os</label></li>
                    <li><input type="checkbox" name="reg" value="regalo_pareja" id="reg3"><label for="reg3">Pareja</label>
                    </li>
                    <li><input type="checkbox" name="reg" value="regalo_corporativo" id="reg4"><label
                            for="reg4">Corporativo</label></li>
                </ul>
            </details>

            {% endif %}
        </div>

    </aside>

    <!-- ===========================
         üî∏ CONTENIDO PRINCIPAL
    ============================ -->
    <main class="catalogo-contenido">

        <!-- Mini Navbar -->
        <div class="mini-navbar" align="center">
            <a href="{% url 'catalogo:productos' %}?seccion=vinos"
                class="nav-item {% if seccion == 'vinos' %}activo{% endif %}">Vinos</a>

            <a href="{% url 'catalogo:productos' %}?seccion=combos"
                class="nav-item {% if seccion == 'combos' %}activo{% endif %}">Combos</a>
        </div>

        <!-- GRID productos -->
        <div id="productos-container"data-filtrar-url="{% if seccion == 'combos' %}{% url 'catalogo:filtrar_combos_cliente' %}{% else %}{% url 'catalogo:filtrar_productos' %}{% endif %}">
            <div class="productos-grid">

                {% for item in productos %}
                <div class="card-producto">

                    <!-- Imagen -->
                    <img src="{% if item.imagen %}{{ item.imagen.url }}{% else %}{% static 'img/default.png' %}{% endif %}" alt="Producto">


                    <!-- Datos -->
                    <h4>{{ item.nombre }}</h4>
                    <p class="precio">${{ item.precio }}</p>

                    {% if item.etiquetas.exists %}
                    <div class="etiquetas-producto">
                        {% for etiqueta in item.etiquetas.all %}
                            <span class="etiqueta">{{ etiqueta.nombre }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="acciones-producto">

                    <!-- Bot√≥n Detalle -->
                    <button 
                            type="button" 
                            class="btn-detalle" 
                            data-modal="modal-detalle-{{ seccion }}-{{ item.id }}">
                            üëÅÔ∏è Detalle
                        </button>
                    
                        <!-- Bot√≥n carrito -->
                        {% if request.session.usuario_id and request.session.usuario_rol == 'cliente' %}

                            {% if seccion == "vinos" %}
                                <form action="{% url 'ventas:agregar_al_carrito' producto_id=item.id %}" method="post" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-carrito">üõí Agregar al carrito</button>
                                </form>
                            
                            {% elif seccion == "combos" %}
                                <form action="{% url 'ventas:agregar_combo_al_carrito' combo_id=item.id %}" method="post" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-carrito">üõí Agregar combo</button>
                                </form>
                            {% endif %}
                            
                        {% else %}
                            <a href="{% url 'usuarios:login' %}" class="btn-carrito">üõí Agregar al carrito</a>
                        {% endif %}
                            
                    
                    </div>

                </div>

                <!-- Modal -->
                <div id="modal-detalle-{{ seccion }}-{{ item.id }}" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>

                        {% if item.imagen %}
                        <img src="{{ item.imagen.url }}" class="modal-img">
                        {% endif %}

                        <h2>{{ item.nombre }}</h2>
                        <p><strong>Precio:</strong> ${{ item.precio }}</p>

                        {% if item.descripcion %}
                        <p><strong>Descripci√≥n:</strong> {{ item.descripcion }}</p>
                        {% endif %}

                        {% if item.categoria %}
                        <p><strong>Categor√≠as:</strong> {{ item.categoria }}</p>
                        {% endif %}
                    </div>
                </div>

                {% empty %}
                <p class="no-productos">No hay {{ seccion }} registrados a√∫n.</p>
                {% endfor %}
            </div>
        </div>

    </main>
</div>


<!-- ===========================
     üß† SCRIPTS
=========================== -->
<script>
/* ======================
   1Ô∏è‚É£ FILTROS AJAX
======================*/
document.addEventListener('DOMContentLoaded', function () {

    function filtrarProductos() {

        const buscar     = document.querySelector(".input-buscar").value;
        const precioMin  = document.querySelectorAll(".input-precio")[0].value;
        const precioMax  = document.querySelectorAll(".input-precio")[1].value;
        const params     = new URLSearchParams();

        params.append("buscar", buscar);
        params.append("precio_min", precioMin);
        params.append("precio_max", precioMax);

        const grupos = ["pais","color","alcohol","uva","vol","fest","prem","reg"];

        grupos.forEach(grupo => {
            const seleccionados = [...document.querySelectorAll(`input[name="${grupo}"]:checked`)]
                                    .map(c => c.value);
            if (seleccionados.length > 0) {
                params.append(grupo, seleccionados.join(","));
            }
        });

        const url = document.querySelector("#productos-container").dataset.filtrarUrl;

        fetch(`${url}?${params.toString()}`)
            .then(r => r.text())
            .then(html => {
                document.querySelector("#productos-container").innerHTML = html;
            })
            .catch(err => console.error("Error en filtrado:", err));
    }

    document.querySelector(".input-buscar").addEventListener("input", filtrarProductos);
    document.querySelectorAll(".input-precio").forEach(i => i.addEventListener("input", filtrarProductos));
    document.querySelectorAll("input[type='checkbox']").forEach(c => c.addEventListener("change", filtrarProductos));
    document.querySelector(".btn-buscar").addEventListener("click", filtrarProductos);
});


/* ======================
   2Ô∏è‚É£ MODALES (EVENTOS DELEGADOS)
======================*/
document.addEventListener("click", function (e) {

    // ‚úî Abrir modal
    if (e.target.classList.contains("btn-detalle")) {
        const id = e.target.dataset.modal;
        const modal = document.getElementById(id);
        modal.classList.add("show");
        document.body.style.overflow = "hidden";
    }

    // ‚úî Cerrar modal con X
    if (e.target.classList.contains("close")) {
        const modal = e.target.closest(".modal");
        modal.classList.remove("show");
        document.body.style.overflow = "";
    }

    // ‚úî Cerrar haciendo click fuera
    if (e.target.classList.contains("modal")) {
        e.target.classList.remove("show");
        document.body.style.overflow = "";
    }
});
</script>



{% endblock %}


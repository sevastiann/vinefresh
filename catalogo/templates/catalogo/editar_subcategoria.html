<!-- ‚úèÔ∏è Modal Editar Subcategor√≠a -->
<div id="modalEditarSubcategoria" class="modal-overlay">
    <div class="modal-content">
        <span id="cerrarModalEditar" class="cerrar-modal">&times;</span>
        <h2>Editar Subcategor√≠a</h2>

        <form method="POST" action="{% url 'catalogo:editar_subcategoria' %}">
            {% csrf_token %}

            <!-- Nivel 1: Secci√≥n -->
            <div class="form-group">
                <label for="seccionEditar">Secci√≥n:</label>
                <select id="seccionEditar" name="seccion" required>
                    <option value="">-- Selecciona una secci√≥n --</option>
                    <option value="productos">Productos</option>
                    <option value="combos">Combos</option>
                </select>
            </div>

            <!-- Nivel 2: Categor√≠a principal -->
            <div class="form-group" id="categoria-container-editar" style="display:none;">
                <label for="categoriaEditar">Categor√≠a principal:</label>
                <select id="categoriaEditar" name="categoria_principal" required></select>
            </div>

            <!-- Nivel 3: Subcategor√≠a a editar -->
            <div class="form-group" id="subcategoria-container-editar" style="display:none;">
                <label for="subcategoriaEditar">Subcategor√≠a:</label>
                <select id="subcategoriaEditar" name="subcategoria_id" required></select>
            </div>

            <!-- Campos de edici√≥n -->
            <div class="form-group" id="form-edicion" style="display:none;">
                <label for="nuevoNombre">Nuevo nombre:</label>
                <input type="text" id="nuevoNombre" name="nuevo_nombre" placeholder="Ingresa el nuevo nombre de la subcategor√≠a" required>
            </div>

            <div class="botones-modal">
                <button type="submit" class="btn-editar">Guardar cambios</button>
                <button type="button" id="cerrarModalEditar2" class="btn-cancelar">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<!-- üé® Estilos -->
<style>
.btn-editar {
    background: #2a7aa1;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
}
.btn-editar:hover { background: #1e587a; }
</style>

<!-- ‚öôÔ∏è Script -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const abrirEditar = document.getElementById("abrirModalEditar");
    const modalEditar = document.getElementById("modalEditarSubcategoria");
    const cerrarEditar = document.getElementById("cerrarModalEditar");
    const cerrarEditar2 = document.getElementById("cerrarModalEditar2");

    const seccionEditar = document.getElementById("seccionEditar");
    const categoriaSelectEditar = document.getElementById("categoriaEditar");
    const subcategoriaSelectEditar = document.getElementById("subcategoriaEditar");
    const categoriaContainerEditar = document.getElementById("categoria-container-editar");
    const subcategoriaContainerEditar = document.getElementById("subcategoria-container-editar");
    const formEdicion = document.getElementById("form-edicion");
    const nuevoNombre = document.getElementById("nuevoNombre");

    // Abrir / cerrar modal
    if (abrirEditar && modalEditar) {
        abrirEditar.onclick = () => modalEditar.style.display = "flex";
        cerrarEditar.onclick = () => modalEditar.style.display = "none";
        cerrarEditar2.onclick = () => modalEditar.style.display = "none";
    }
    window.onclick = e => { if (e.target === modalEditar) modalEditar.style.display = "none"; };

    // Cargar datos desde Django
    const categoriasData = JSON.parse('{{ categorias_json|escapejs }}');
    const subcategoriasData = JSON.parse('{{ subcategorias_json|escapejs }}');

    // Paso 1: Secci√≥n ‚Üí Categor√≠as principales
    seccionEditar.addEventListener('change', () => {
        const seccion = seccionEditar.value;
        categoriaSelectEditar.innerHTML = '';
        subcategoriaSelectEditar.innerHTML = '';
        subcategoriaContainerEditar.style.display = 'none';
        formEdicion.style.display = 'none';

        if (!seccion) {
            categoriaContainerEditar.style.display = 'none';
            return;
        }

        categoriaContainerEditar.style.display = 'block';
        const defaultOption = document.createElement('option');
        defaultOption.text = '-- Selecciona una categor√≠a principal --';
        defaultOption.value = '';
        categoriaSelectEditar.appendChild(defaultOption);

        if (categoriasData[seccion]) {
            categoriasData[seccion].forEach(([valor, nombre]) => {
                const opt = document.createElement('option');
                opt.value = valor;
                opt.text = nombre;
                categoriaSelectEditar.appendChild(opt);
            });
        }
    });

    // Paso 2: Categor√≠a principal ‚Üí Subcategor√≠as reales
    categoriaSelectEditar.addEventListener('change', () => {
        const seccion = seccionEditar.value;
        const categoria = categoriaSelectEditar.value;
        subcategoriaSelectEditar.innerHTML = '';
        formEdicion.style.display = 'none';

        if (!categoria) {
            subcategoriaContainerEditar.style.display = 'none';
            return;
        }

        subcategoriaContainerEditar.style.display = 'block';
        const defaultOption = document.createElement('option');
        defaultOption.text = '-- Selecciona una subcategor√≠a --';
        defaultOption.value = '';
        subcategoriaSelectEditar.appendChild(defaultOption);

        const subcats = subcategoriasData.filter(
            s => s.seccion === seccion && s.categoria_principal === categoria
        );

        if (subcats.length > 0) {
            subcats.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.text = s.nombre;
                subcategoriaSelectEditar.appendChild(opt);
            });
        } else {
            const noOpt = document.createElement('option');
            noOpt.text = '(No hay subcategor√≠as disponibles)';
            noOpt.disabled = true;
            subcategoriaSelectEditar.appendChild(noOpt);
        }
    });

    // Paso 3: Mostrar campo de edici√≥n al seleccionar subcategor√≠a
    subcategoriaSelectEditar.addEventListener('change', () => {
        const subcategoriaId = subcategoriaSelectEditar.value;
        if (!subcategoriaId) {
            formEdicion.style.display = 'none';
            return;
        }

        const subcat = subcategoriasData.find(s => s.id == subcategoriaId);
        if (subcat) {
            nuevoNombre.value = subcat.nombre;
            formEdicion.style.display = 'block';
        }
    });
});
</script>

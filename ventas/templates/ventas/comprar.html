{% extends 'core/base.html' %}
{% load static %}

{% block title %}Confirmar Pedido{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/ventas/comprar.css' %}">

<div class="container mt-4">

    <h2 class="mb-4">üìù Confirmar Pedido</h2>
    <a href="{% url 'ventas:carrito' %}" class="btn btn-secondary mb-3">
        ‚¨Ö Volver al carrito
    </a>

    <!-- PROGRESO -->
    <div class="progress-bar mt-3" style="height: 20px; background: #e9ecef; border-radius: 10px;">
        <div id="progressFill" style="width: 33%; height: 100%; background: #198754; border-radius: 10px; transition: 0.3s;"></div>
    </div>

    <!-- FORMULARIO -->
    <form method="POST" id="pedidoForm" action="{% url 'ventas:comprar' %}">
        {% csrf_token %}


        <!-- ============================
             SECCI√ìN 1 ‚Äî DATOS CLIENTE
        ================================ -->
        <div class="form-section" id="section1">
            <div class="card p-3 mb-4">
                <h4>üë§ Tus Datos</h4>

                <div class="mb-3">
                    <label class="form-label">Nombre completo:</label>
                    <input type="text" name="nombre"
                        class="form-control"
                        value="{{ user.nombre_usuario|default:'' }}"
                        required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Direcci√≥n:</label>
                    <input type="text" name="direccion"
                        class="form-control"
                        value="{{ user.direccion|default:'' }}"
                        required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Tel√©fono:</label>
                    <input type="text" name="telefono"
                        class="form-control"
                        value="{{ user.telefono|default:'' }}"
                        required>
                </div>
            </div>
        </div>


        <!-- ============================
             SECCI√ìN 2 ‚Äî PRODUCTOS
        ================================ -->
        <div class="form-section" id="section2" style="display:none;">
            {% if carrito_items %}
            <h4 class="mt-4">üì¶ Productos</h4>

            <table class="table table-bordered mt-2">
                <thead class="table-dark">
                    <tr>
                        <th>Producto</th>
                        <th>Imagen</th>
                        <th>Cantidad</th>
                        <th>Precio</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in carrito_items %}
                    <tr>
                        <td>{{ item.producto.nombre }}</td>
                        <td><img src="{{ item.producto.imagen.url }}" width="70"></td>
                        <td>{{ item.cantidad }}</td>
                        <td>${{ item.producto.precio }}</td>
                        <td>${{ item.subtotal }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>


        <!-- ============================
             SECCI√ìN 3 ‚Äî COMBOS
        ================================ -->
        <div class="form-section" id="section3" style="display:none;">
            {% if carrito_combos %}
            <h4 class="mt-4">üéÅ Combos</h4>

            <table class="table table-bordered mt-2">
                <thead class="table-dark">
                    <tr>
                        <th>Combo</th>
                        <th>Imagen</th>
                        <th>Cantidad</th>
                        <th>Precio</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in carrito_combos %}
                    <tr>
                        <td>{{ item.combo.nombre }}</td>
                        <td><img src="{{ item.combo.imagen.url }}" width="70"></td>
                        <td>{{ item.cantidad }}</td>
                        <td>${{ item.combo.precio }}</td>
                        <td>${{ item.subtotal }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}

            <h3 class="mt-4">üí≥ Total a pagar: ${{ total_carrito }}</h3>
        </div>


        <!-- BOTONES -->
        <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" id="prevBtn">Anterior</button>
            <button type="button" class="btn btn-primary" id="nextBtn">Siguiente</button>
            <button type="submit" id="submitBtn" class="btn btn-success" style="display:none;">
                ‚úî Confirmar Pedido
            </button>
        </div>

    </form>
</div>

<style>
h2, h3, h4 {
    font-family: "Playfair Display", serif;
}

.table img {
    border-radius: 10px;
    border: 1px solid #c9b88a;
}

.btn-success {
    background: linear-gradient(135deg, #c7b37c, #b49c63);
    border: none;
}
</style>

<script>
/* =======================================================
   WIZARD INTELIGENTE ‚Äî SOLO MUESTRA PASOS NECESARIOS
==========================================================*/

// Secciones
let section1 = document.getElementById("section1");
let section2 = document.getElementById("section2");
let section3 = document.getElementById("section3");

// Detectar contenido real
let hasProducts = section2.querySelector("table") !== null;
let hasCombos = section3.querySelector("table") !== null;

// Crear array din√°mico de secciones
let sections = [section1];
if (hasProducts) sections.push(section2);
if (hasCombos) sections.push(section3);

let index = 0;

// Botones
const nextBtn = document.getElementById("nextBtn");
const prevBtn = document.getElementById("prevBtn");
const submitBtn = document.getElementById("submitBtn");
const progressFill = document.getElementById("progressFill");

// Mostrar secci√≥n activa
function showSection(i) {
    sections.forEach((sec, n) => {
        sec.style.display = (n === i ? "block" : "none");
    });

    // Barra de progreso
    progressFill.style.width = ((i + 1) / sections.length * 100) + "%";

    // Botones
    prevBtn.style.display = (i === 0) ? "none" : "inline-block";
    nextBtn.style.display = (i === sections.length - 1) ? "none" : "inline-block";
    submitBtn.style.display = (i === sections.length - 1) ? "inline-block" : "none";
}

// Eventos
nextBtn.addEventListener("click", () => {
    if (index < sections.length - 1) {
        index++;
        showSection(index);
    }
});

prevBtn.addEventListener("click", () => {
    if (index > 0) {
        index--;
        showSection(index);
    }
});

// Inicializaci√≥n
showSection(index);
</script>

{% endblock %}
